自己紹介

@_takwat

青森県八戸市
- 首都圏で10年ほど働いて通勤地獄に疲れ果てる
-
- インフィニットループ仙台支社(2019/07〜)
- 侵入社員
- インフラやったりフロントエンドとバックエンド半々ぐらい
- 中途半端すぎてフルスタックなんてかっこよく自称できない

COBOL / Perl / PHP / Visual Basic / Node.js / Go
MySQL / PostgreSQL / MongoDB / elasticsearch
memcached / Redis


HTML / CSS / JavaScript







趣味

- 温泉











新入りなのでそこまでディープな話題はできません


軽めのところで攻めようと





愛用開発環境
Vagrant + VirtualBox
Visual Studio Code + Remote Development Extension
ngrok
Firebase





Vagrant
仮想化ソフトの違いをいい感じに吸収してくれる
設定ファイル(Vagrantfileというファイル名でRubyのスクリプトになってます)である程度仮想マシンの構築を自動化してくれる
さらに仮想マシンのOSでAnsibleという構成管理ツールをサポートしていれば、それを扱うVagrantの拡張機能を使うことで仮想マシンの中のソフトウェアの構築(Apache入れて、PHPのこのバージョン入れて・・・など)まで自動化できる
Vagrantfileでシェルスクリプトを実行するように書けばAnsible使わなくてもいけますが辛いです

VagrantfileとAnsibleの構成定義(Playbookといいます)はテキストなので、これをgithubに預けておけばVagrantとVirtualBoxが入ってるマシンならどこでも同じ仮想マシンを立ち上げることが可能

https://github.com/takwat/vagrant-lamp

こうしておけば気軽にスクラップ(vagrant destroy)アンドビルド(vagrant up)ができる上にサーバ構築手順書みたいな「秘伝のタレ」を作らずにすむ


仮想化ソフトについて

今はVagrant+VirtualBoxがいい意味で枯れてるので個人的に気に入って使っていますが
Windows 10ならWindows Subsystem for Linux(WSL)という面白そうな環境もあるので試してみるのもいいかもしれません
次のWindows 10の大規模アップデートでMSが本気出して作ったLinuxカーネルでかなりパフォーマンスが上がったWSL2というのが入るとか入らないとか
現状のWSL使ってみたときはファイルI/OとDocker周りのサポートが少し残念な感じになっていたのでWSL2には期待してます







Visual Studio Code + Remote Development Extension

例として

gitで管理される
PHPで書かれているアプリケーションを
Linux環境で実行する

テーマやシンタクスハイライトなどのUIに関する部分の拡張だけがローカルにインストールされる
リモートマシンにリモート側の仕事(Git関連、XDebugによるPHPのブレークポイント設置やステップ実行、コードスタイルのチェックなど)をこなす拡張が入ってローカル側のVSCodeと通信する
この拡張、Node.jsで動いているので接続先のリモート側のプラットフォームに接続の受け皿となるSSHサーバとNode.jsのサポートが必須かも(Linuxなら安心して使えます)

今はVagrant+VirtualBoxでローカル側と同じマシンにLinux環境をたててますが、物理的に分離されたどっかのマシンに置き換えても同じ
(Remote Development拡張の接続先がlocalhostになるかどっかのIPアドレスになるかの違い)

ローカル側でやることは仮想環境や物理的に離れた別マシン扱いの開発環境を切り替えるだけ

ソースコードはリモート側にあるものをいじるし、gitやPHPインタプリタもリモート側のものを使う
ファイルの保存以外はリモート側の内部の世界で処理される模様をVSCodeから覗き見するのでローカル側に開発環境(WindowsやMac用のPHPなどの一式)をインストールする必要はない
ローカル側でインストールするとプロジェクトごとに準備するべきPHPやその他パッケージなどのバージョンが違ったりしてローカル側の環境が混沌としてくるが、このリスクがない

デメリットはファイルをSSH越しにいじるぶん、ファイルの保存や参照が若干遅い
物理的に同じマシンの仮想環境につないでいる場合はそこまで絶望的なラグは感じない







仮想環境で開発してるときの「つらみ」

この環境をインターネット越しに検証するのが難しい


仮想環境のネットワークをブリッジ接続にしてホストやルータと同じにしたり
ルータにのポート開放したり

正直面倒

そもそも今つないでるの公衆無線LAN
固定IP環境じゃない
ルータいじれない
いじれたとしてホスト名どうするの？非エンジニアにhosts書かせるの？
(WindowsだとUAC絡みで説明するの地味に億劫なんですよね、あれ)

とかもある

そこで登場

ngrok


ngrokのクライアントをインストールして起動する

クライアントはngrokのサービスにSSHで接続する
そのSSHのコネクションをトンネルにして仮想環境へのアクセス経路をあけてくれる


たとえばVagrantで立ち上げた仮想環境に対して予め
localhost:8080 => vagrant:8080 とマッピングして

ngrok http 8080

と起動すると

https://foo-bar-baz.ngrok.io/

でアクセスされたリクエストをクライアント起動時に指定したポート宛にリバースプロキシしてくれる

オレオレ証明書ではない素のHTTPSなURLでいけるので、HTTPSじゃないと許可してもらえないようなAPI通信などのコールバックにも指定できる
ただし通信経路が細いトンネルだけなので自分や限られた人だけでやるテスト用と割り切ること

ngrok ssh 22

でsshへのアクセス経路も開通できます 


Vagrantならvagrant shareという拡張があって後ろ側ではこのサービスを使ってます
